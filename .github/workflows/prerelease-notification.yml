name: Prerelease Notification

on:
  push:
    branches:
      - atavism/pr-summary
  workflow_run:
    workflows:
      - Publish releases
    types:
      - completed
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate PR Summary
        id: pr-summary
        run: |
          REPO_URL="https://github.com/getlantern/lantern-client"
          git fetch --depth=100 origin
          PR_SUMMARY=$(git log --since="1 week ago" --pretty=format:"%h %s" | grep -E "#[0-9]+" | sed -E 's|#([0-9]+)|[#\1]('"$REPO_URL"'/pull/\1)|')
          echo "::set-output name=summary::${PR_SUMMARY}"

      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.LANTERN_APP_SLACK_RELEASES_WEBHOOK }}
        run: |
          SLACK_MESSAGE="TEST: *A new release is available!* ðŸš€\n\n:${{ steps.pr-summary.outputs.summary }}"
          echo "$SLACK_MESSAGE"
          # curl -X POST -H 'Content-type: application/json' \
          # --data "{\"text\":\"${SLACK_MESSAGE}\"}" $SLACK_WEBHOOK_URL
